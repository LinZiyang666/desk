[rank0]: Traceback (most recent call last):
[rank0]:   File "/local/desk/qwen2.5_omni_3b_devide_head.py", line 968, in <module>
[rank0]:     main()
[rank0]:   File "/local/desk/qwen2.5_omni_3b_devide_head.py", line 794, in main
[rank0]:     sched.step(audio_inputs=aud_pack, attention_mask=attn, target=tgt)
[rank0]:   File "/local/desk/pipelining_source_code/schedules.py", line 1366, in step
[rank0]:     self._step_microbatches(args_split, kwargs_split, targets_split, losses)
[rank0]:   File "/local/desk/schedule_runtime.py", line 1620, in _step_microbatches
[rank0]:     raise e
[rank0]:   File "/local/desk/schedule_runtime.py", line 1432, in _step_microbatches
[rank0]:     _normalize_model_output_as_tuple(split_out[idx]),
[rank0]:                                      ~~~~~~~~~^^^^^
[rank0]: IndexError: list index out of range

[rank1]: Traceback (most recent call last):
[rank1]:   File "/local/desk/qwen2.5_omni_3b_devide_head.py", line 968, in <module>
[rank1]:     main()
[rank1]:   File "/local/desk/qwen2.5_omni_3b_devide_head.py", line 817, in main
[rank1]:     sched.step(vision_inputs=vis_pack, attention_mask=attn, target=tgt)
[rank1]:   File "/local/desk/pipelining_source_code/schedules.py", line 1366, in step
[rank1]:     self._step_microbatches(args_split, kwargs_split, targets_split, losses)
[rank1]:   File "/local/desk/schedule_runtime.py", line 1620, in _step_microbatches
[rank1]:     raise e
[rank1]:   File "/local/desk/schedule_runtime.py", line 1394, in _step_microbatches
[rank1]:     output = stage.forward_one_chunk(rep_id, cat_args, cat_kwargs, len(mb_ids))
[rank1]:              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank1]:   File "/local/desk/stage_with_mutiple_ranks.py", line 1630, in forward_one_chunk
[rank1]:     return super().forward_one_chunk(fwd_chunk_id, args, clean_kwargs, pack_size)
[rank1]:            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank1]:   File "/local/desk/stage_with_mutiple_ranks.py", line 608, in forward_one_chunk
[rank1]:     composite_args = self._retrieve_recv_activations(fwd_chunk_id)
[rank1]:                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank1]:   File "/local/desk/pipelining_source_code/stage.py", line 560, in _retrieve_recv_activations
[rank1]:     activations = self._map_tensor_from_recv_info(recv_infos)
[rank1]:                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank1]:   File "/local/desk/stage_with_mutiple_ranks.py", line 1043, in _map_tensor_from_recv_info
[rank1]:     return map_aggregate(cast(Argument, recv_infos), get_recv_tensor)
[rank1]:            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank1]:   File "/local/miniconda3/envs/qwencpu/lib/python3.11/site-packages/torch/fx/node.py", line 873, in map_aggregate
[rank1]:     return _fx_map_aggregate(a, fn)
[rank1]:            ^^^^^^^^^^^^^^^^^^^^^^^^
[rank1]:   File "/local/desk/stage_with_mutiple_ranks.py", line 1041, in get_recv_tensor
[rank1]:     raise AssertionError(f"Expected _RecvInfo or None but got {type(info)}")
[rank1]: AssertionError: Expected _RecvInfo or None but got <class 'pipelining_source_code.stage._RootArgPlaceholder'>

rank0 rank1出错位置：
         Rank 0            Rank 1            Rank 2            Rank 3            Rank 4            Rank 5           
Step 00: 0,0,F,0,          0,1,F,0,          0,2,F,0,          1,3,RECV_F,(0,),0 2,4,RECV_F,(0,),3 3,5,RECV_F,(0,),4 <-- ERROR HERE
Step 01: 0,0,SEND_F,(0,),3 0,1,SEND_F,(0,),3 0,2,SEND_F,(0,),3 1,3,RECV_F,(0,),1 2,4,F,0,          3,5,F,0,         
Step 02: 0,0,F,1,          0,1,F,1,          0,2,F,1,          1,3,RECV_F,(0,),2 2,4,SEND_F,(0,),5 3,5,RECV_F,(1,),4
Step 03: 0,0,SEND_F,(1,),3 0,1,SEND_F,(1,),3 0,2,SEND_F,(1,),3 1,3,F,0,          2,4,RECV_F,(1,),3 3,5,F,1,         
Step 04: 0,0,F,2,          0,1,F,2,          0,2,F,2,          1,3,SEND_F,(0,),4 2,4,F,1,          3,5,RECV_F,(2,),4
Step 05: 0,0,SEND_F,(2,),3 0,1,SEND_F,(2,),3 0,2,SEND_F,(2,),3 1,3,RECV_F,(1,),0 2,4,SEND_F,(1,),5 3,5,F,2,         
Step 06: 0,0,F,3,          0,1,F,3,          0,2,F,3,          1,3,RECV_F,(1,),1 2,4,RECV_F,(2,),3 3,5,RECV_F,(3,),4
Step 07: 0,0,SEND_F,(3,),3 0,1,SEND_F,(3,),3 0,2,SEND_F,(3,),3 1,3,RECV_F,(1,),2 2,4,F,2,          3,5,F,3,         
Step 08: 0,0,RECV_B,(0,),3 0,1,RECV_B,(0,),3 0,2,RECV_B,(0,),3 1,3,F,1,          2,4,SEND_F,(2,),5 3,5,B,0,         
Step 09: 0,0,B,0,          0,1,B,0,          0,2,B,0,          1,3,SEND_F,(1,),4 2,4,RECV_F,(3,),3 3,5,SEND_B,(0,),4
Step 10: 0,0,RECV_B,(1,),3 0,1,RECV_B,(1,),3 0,2,RECV_B,(1,),3 1,3,RECV_F,(2,),0 2,4,F,3,          3,5,B,1,         
Step 11: 0,0,B,1,          0,1,B,1,          0,2,B,1,          1,3,RECV_F,(2,),1 2,4,SEND_F,(3,),5 3,5,SEND_B,(1,),4
Step 12: 0,0,RECV_B,(2,),3 0,1,RECV_B,(2,),3 0,2,RECV_B,(2,),3 1,3,RECV_F,(2,),2 2,4,RECV_B,(0,),5 3,5,B,2,         
Step 13: 0,0,B,2,          0,1,B,2,          0,2,B,2,          1,3,F,2,          2,4,B,0,          3,5,SEND_B,(2,),4
Step 14: 0,0,RECV_B,(3,),3 0,1,RECV_B,(3,),3 0,2,RECV_B,(3,),3 1,3,SEND_F,(2,),4 2,4,SEND_B,(0,),3 3,5,B,3,         
Step 15: 0,0,B,3,          0,1,B,3,          0,2,B,3,          1,3,RECV_F,(3,),0 2,4,RECV_B,(1,),5 3,5,SEND_B,(3,),4
Step 16:                                                       1,3,RECV_F,(3,),1 2,4,B,1,                           
Step 17:                                                       1,3,RECV_F,(3,),2 2,4,SEND_B,(1,),3                  
Step 18:                                                       1,3,F,3,          2,4,RECV_B,(2,),5                  
Step 19:                                                       1,3,SEND_F,(3,),4 2,4,B,2,                           
Step 20:                                                       1,3,RECV_B,(0,),4 2,4,SEND_B,(2,),3                  
Step 21:                                                       1,3,B,0,          2,4,RECV_B,(3,),5                  
Step 22:                                                       1,3,SEND_B,(0,),0 2,4,B,3,                           
Step 23:                                                       1,3,SEND_B,(0,),1 2,4,SEND_B,(3,),3                  
Step 24:                                                       1,3,SEND_B,(0,),2                                    
Step 25:                                                       1,3,RECV_B,(1,),4                                    
Step 26:                                                       1,3,B,1,                                             
Step 27:                                                       1,3,SEND_B,(1,),0                                    
Step 28:                                                       1,3,SEND_B,(1,),1                                    
Step 29:                                                       1,3,SEND_B,(1,),2                                    
Step 30:                                                       1,3,RECV_B,(2,),4                                    
Step 31:                                                       1,3,B,2,                                             
Step 32:                                                       1,3,SEND_B,(2,),0                                    
Step 33:                                                       1,3,SEND_B,(2,),1                                    
Step 34:                                                       1,3,SEND_B,(2,),2                                    
Step 35:                                                       1,3,RECV_B,(3,),4                                    
Step 36:                                                       1,3,B,3,                                             
Step 37:                                                       1,3,SEND_B,(3,),0                                    
Step 38:                                                       1,3,SEND_B,(3,),1                                    
Step 39:                                                       1,3,SEND_B,(3,),2          

















[rank2]: Traceback (most recent call last):
[rank2]:   File "/local/desk/qwen2.5_omni_3b_devide_head.py", line 968, in <module>
[rank2]:     main()
[rank2]:   File "/local/desk/qwen2.5_omni_3b_devide_head.py", line 820, in main
[rank2]:     sched.step(inp_ids, attention_mask=attn, target=tgt)
[rank2]:   File "/local/desk/pipelining_source_code/schedules.py", line 1366, in step
[rank2]:     self._step_microbatches(args_split, kwargs_split, targets_split, losses)
[rank2]:   File "/local/desk/schedule_runtime.py", line 1620, in _step_microbatches
[rank2]:     raise e
[rank2]:   File "/local/desk/schedule_runtime.py", line 1229, in _step_microbatches
[rank2]:     ops = stage.get_bwd_recv_ops_mm(
[rank2]:           ^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank2]: TypeError: PipelineStage_Multimodality.get_bwd_recv_ops_mm() got an unexpected keyword argument 'dest_rank'
rank2出错位置：
         Rank 0            Rank 1            Rank 2            Rank 3            Rank 4            Rank 5           
Step 00: 0,0,F,0,          0,1,F,0,          0,2,F,0,          1,3,RECV_F,(0,),0 2,4,RECV_F,(0,),3 3,5,RECV_F,(0,),4
Step 01: 0,0,SEND_F,(0,),3 0,1,SEND_F,(0,),3 0,2,SEND_F,(0,),3 1,3,RECV_F,(0,),1 2,4,F,0,          3,5,F,0,         
Step 02: 0,0,F,1,          0,1,F,1,          0,2,F,1,          1,3,RECV_F,(0,),2 2,4,SEND_F,(0,),5 3,5,RECV_F,(1,),4
Step 03: 0,0,SEND_F,(1,),3 0,1,SEND_F,(1,),3 0,2,SEND_F,(1,),3 1,3,F,0,          2,4,RECV_F,(1,),3 3,5,F,1,         
Step 04: 0,0,F,2,          0,1,F,2,          0,2,F,2,          1,3,SEND_F,(0,),4 2,4,F,1,          3,5,RECV_F,(2,),4
Step 05: 0,0,SEND_F,(2,),3 0,1,SEND_F,(2,),3 0,2,SEND_F,(2,),3 1,3,RECV_F,(1,),0 2,4,SEND_F,(1,),5 3,5,F,2,         
Step 06: 0,0,F,3,          0,1,F,3,          0,2,F,3,          1,3,RECV_F,(1,),1 2,4,RECV_F,(2,),3 3,5,RECV_F,(3,),4
Step 07: 0,0,SEND_F,(3,),3 0,1,SEND_F,(3,),3 0,2,SEND_F,(3,),3 1,3,RECV_F,(1,),2 2,4,F,2,          3,5,F,3,         
Step 08: 0,0,RECV_B,(0,),3 0,1,RECV_B,(0,),3 0,2,RECV_B,(0,),3 1,3,F,1,          2,4,SEND_F,(2,),5 3,5,B,0,          <-- ERROR HERE
Step 09: 0,0,B,0,          0,1,B,0,          0,2,B,0,          1,3,SEND_F,(1,),4 2,4,RECV_F,(3,),3 3,5,SEND_B,(0,),4
Step 10: 0,0,RECV_B,(1,),3 0,1,RECV_B,(1,),3 0,2,RECV_B,(1,),3 1,3,RECV_F,(2,),0 2,4,F,3,          3,5,B,1,         
Step 11: 0,0,B,1,          0,1,B,1,          0,2,B,1,          1,3,RECV_F,(2,),1 2,4,SEND_F,(3,),5 3,5,SEND_B,(1,),4
Step 12: 0,0,RECV_B,(2,),3 0,1,RECV_B,(2,),3 0,2,RECV_B,(2,),3 1,3,RECV_F,(2,),2 2,4,RECV_B,(0,),5 3,5,B,2,         
Step 13: 0,0,B,2,          0,1,B,2,          0,2,B,2,          1,3,F,2,          2,4,B,0,          3,5,SEND_B,(2,),4
Step 14: 0,0,RECV_B,(3,),3 0,1,RECV_B,(3,),3 0,2,RECV_B,(3,),3 1,3,SEND_F,(2,),4 2,4,SEND_B,(0,),3 3,5,B,3,         
Step 15: 0,0,B,3,          0,1,B,3,          0,2,B,3,          1,3,RECV_F,(3,),0 2,4,RECV_B,(1,),5 3,5,SEND_B,(3,),4
Step 16:                                                       1,3,RECV_F,(3,),1 2,4,B,1,                           
Step 17:                                                       1,3,RECV_F,(3,),2 2,4,SEND_B,(1,),3                  
Step 18:                                                       1,3,F,3,          2,4,RECV_B,(2,),5                  
Step 19:                                                       1,3,SEND_F,(3,),4 2,4,B,2,                           
Step 20:                                                       1,3,RECV_B,(0,),4 2,4,SEND_B,(2,),3                  
Step 21:                                                       1,3,B,0,          2,4,RECV_B,(3,),5                  
Step 22:                                                       1,3,SEND_B,(0,),0 2,4,B,3,                           
Step 23:                                                       1,3,SEND_B,(0,),1 2,4,SEND_B,(3,),3                  
Step 24:                                                       1,3,SEND_B,(0,),2                                    
Step 25:                                                       1,3,RECV_B,(1,),4                                    
Step 26:                                                       1,3,B,1,                                             
Step 27:                                                       1,3,SEND_B,(1,),0                                    
Step 28:                                                       1,3,SEND_B,(1,),1                                    
Step 29:                                                       1,3,SEND_B,(1,),2                                    
Step 30:                                                       1,3,RECV_B,(2,),4                                    
Step 31:                                                       1,3,B,2,                                             
Step 32:                                                       1,3,SEND_B,(2,),0                                    
Step 33:                                                       1,3,SEND_B,(2,),1                                    
Step 34:                                                       1,3,SEND_B,(2,),2                                    
Step 35:                                                       1,3,RECV_B,(3,),4                                    
Step 36:                                                       1,3,B,3,                                             
Step 37:                                                       1,3,SEND_B,(3,),0                                    
Step 38:                                                       1,3,SEND_B,(3,),1                                    
Step 39:                                                       1,3,SEND_B,(3,),2   

对于get_bwd_recv_ops_mm，和get_bwd_recv_ops_mm（这两个都需要）来说我们需要可以直接指定从哪里接收的desk_rank，不要用src_rank_fallback来推peer_rank，我不需要推到因为我已经指定，他的方向我在action里面指定了，请为我修改






其他的rank都因为上面rank出错而被挂掉